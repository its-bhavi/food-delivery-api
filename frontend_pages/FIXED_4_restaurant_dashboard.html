<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Dashboard - Orders</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .topbar { background: linear-gradient(135deg, #fc8019 0%, #e23744 100%); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .topbar h1 { font-size: 24px; }
        .profile-btn { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 8px; color: white; text-decoration: none; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid; }
        .stat-card.pending { border-color: #f39c12; }
        .stat-card.confirmed { border-color: #3498db; }
        .stat-card.preparing { border-color: #9b59b6; }
        .stat-card.ready { border-color: #27ae60; }
        .stat-icon { font-size: 36px; margin-bottom: 10px; }
        .stat-number { font-size: 32px; font-weight: 700; color: #282c3f; }
        .stat-label { color: #7e808c; font-size: 14px; margin-top: 5px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .filter-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-tab { padding: 10px 20px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; font-weight: 600; color: #7e808c; transition: all 0.3s; }
        .filter-tab.active { background: #fc8019; color: white; border-color: #fc8019; }
        .btn-refresh { padding: 10px 20px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; font-weight: 600; color: #282c3f; }
        .orders-grid { display: grid; gap: 20px; }
        .order-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .order-number { font-size: 20px; font-weight: 700; color: #282c3f; }
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; color: white; }
        .status-badge.pending { background: #f39c12; }
        .status-badge.confirmed { background: #3498db; }
        .status-badge.preparing { background: #9b59b6; }
        .status-badge.ready { background: #27ae60; }
        .status-badge.picked { background: #e67e22; }
        .order-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .detail-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f8f8; border-radius: 8px; }
        .detail-label { color: #7e808c; font-size: 13px; }
        .detail-value { color: #282c3f; font-weight: 600; font-size: 14px; }
        .order-items { background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .order-items strong { display: block; margin-bottom: 10px; color: #282c3f; font-size: 14px; }
        .item-line { padding: 5px 0; color: #282c3f; font-size: 14px; }
        .order-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action { flex: 1; min-width: 150px; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-accept { background: #27ae60; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-preparing { background: #9b59b6; color: white; }
        .btn-ready { background: #10b981; color: white; }
        .btn-view-map { background: #3498db; color: white; }
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top-color: #fc8019; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 80px 20px; background: white; border-radius: 12px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { font-size: 30px; cursor: pointer; color: #7e808c; }
        .map-container { height: 350px; border-radius: 12px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666; }
    </style>
</head>
<body>
    <div class="topbar">
        <h1>üçΩÔ∏è Restaurant Dashboard</h1>
        <a href="/restaurant-profile/" class="profile-btn">‚öôÔ∏è Profile Settings</a>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-number" id="statPending">0</div>
                <div class="stat-label">Pending Orders</div>
            </div>
            <div class="stat-card confirmed">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="statConfirmed">0</div>
                <div class="stat-label">Confirmed</div>
            </div>
            <div class="stat-card preparing">
                <div class="stat-icon">üë®‚Äçüç≥</div>
                <div class="stat-number" id="statPreparing">0</div>
                <div class="stat-label">Preparing</div>
            </div>
            <div class="stat-card ready">
                <div class="stat-icon">üì¶</div>
                <div class="stat-number" id="statReady">0</div>
                <div class="stat-label">Ready for Pickup</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterOrders('all')">All Orders</button>
                <button class="filter-tab" onclick="filterOrders('pending')">Pending</button>
                <button class="filter-tab" onclick="filterOrders('confirmed')">Confirmed</button>
                <button class="filter-tab" onclick="filterOrders('preparing')">Preparing</button>
                <button class="filter-tab" onclick="filterOrders('ready')">Ready</button>
            </div>
            <button class="btn-refresh" onclick="loadOrders()">üîÑ Refresh</button>
        </div>

        <div id="ordersContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading orders...</p>
            </div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìç Delivery Location</h2>
                <span class="close-modal" onclick="closeMapModal()">√ó</span>
            </div>
            <div id="mapContainer" class="map-container">
                <div>Map loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://food-delivery-api-production-1d00.up.railway.app/api';
        let allOrders = [];
        let currentFilter = 'all';
        let modalMap, modalMarker;

        function getToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }

        async function loadOrders() {
            const token = getToken();
            if (!token) {
                alert('Please login first');
                window.location.href = '/login/';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/orders/vendor-orders/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load orders');

                const data = await response.json();
                allOrders = Array.isArray(data) ? data : (data.orders || []);
                console.log('üì¶ Orders loaded:', allOrders.length);
                
                updateStats();
                displayOrders();
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load orders: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateStats() {
            const stats = {
                pending: allOrders.filter(o => o.status === 'pending').length,
                confirmed: allOrders.filter(o => o.status === 'confirmed').length,
                preparing: allOrders.filter(o => o.status === 'preparing').length,
                ready: allOrders.filter(o => o.status === 'ready').length
            };
            
            document.getElementById('statPending').textContent = stats.pending;
            document.getElementById('statConfirmed').textContent = stats.confirmed;
            document.getElementById('statPreparing').textContent = stats.preparing;
            document.getElementById('statReady').textContent = stats.ready;
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            displayOrders();
        }

        function displayOrders() {
            let filtered = currentFilter === 'all' ? allOrders : allOrders.filter(o => o.status === currentFilter);
            
            if (filtered.length === 0) {
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty-state">
                        <p>üì¶ No ${currentFilter} orders</p>
                    </div>
                `;
                return;
            }

            const html = filtered.map(order => createOrderCard(order)).join('');
            document.getElementById('ordersContainer').innerHTML = `<div class="orders-grid">${html}</div>`;
        }

        function createOrderCard(order) {
            const items = Array.isArray(order.items) ? order.items : [];
            const itemsHTML = items.map(item => `
                <div class="item-line">${item.quantity}x ${item.menu_item?.name || 'Item'}</div>
            `).join('');

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">#${order.order_number}</div>
                        <div class="status-badge ${order.status}">${order.status.toUpperCase()}</div>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <span class="detail-label">Customer</span>
                            <span class="detail-value">${order.customer?.first_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value">${order.customer?.phone_number || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount</span>
                            <span class="detail-value">‚Çπ${parseFloat(order.grand_total || 0).toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment</span>
                            <span class="detail-value">${order.payment_method === 'cod' ? 'COD' : 'Paid'}</span>
                        </div>
                    </div>

                    <div class="order-items">
                        <strong>üìã Items Ordered:</strong>
                        ${itemsHTML || '<div class="item-line">No items</div>'}
                    </div>

                    <div class="order-actions">
                        ${getActionButtons(order)}
                    </div>
                </div>
            `;
        }

        function getActionButtons(order) {
            if (order.status === 'pending') {
                return `
                    <button class="btn-action btn-accept" onclick="updateStatus(${order.id}, 'confirmed')">‚úÖ Accept Order</button>
                    <button class="btn-action btn-reject" onclick="updateStatus(${order.id}, 'rejected')">‚ùå Reject</button>
                    <button class="btn-action btn-view-map" onclick="showMapModal('${escapeHtml(order.delivery_address || '')}')">üó∫Ô∏è View Location</button>
                `;
            } else if (order.status === 'confirmed') {
                return `
                    <button class="btn-action btn-preparing" onclick="updateStatus(${order.id}, 'preparing')">üë®‚Äçüç≥ Start Preparing</button>
                    <button class="btn-action btn-view-map" onclick="showMapModal('${escapeHtml(order.delivery_address || '')}')">üó∫Ô∏è View Location</button>
                `;
            } else if (order.status === 'preparing') {
                return `
                    <button class="btn-action btn-ready" onclick="updateStatus(${order.id}, 'ready')">‚úÖ Mark Ready</button>
                    <button class="btn-action btn-view-map" onclick="showMapModal('${escapeHtml(order.delivery_address || '')}')">üó∫Ô∏è View Location</button>
                `;
            } else if (order.status === 'ready') {
                return `
                    <div style="padding:12px;background:#d4edda;border-radius:8px;text-align:center;color:#155724;">
                        üì¶ Out for delivery - Waiting for delivery partner
                    </div>
                    <button class="btn-action btn-view-map" onclick="showMapModal('${escapeHtml(order.delivery_address || '')}')">üó∫Ô∏è View Location</button>
                `;
            }
            return `<div style="padding:12px;background:#f0f0f5;border-radius:8px;text-align:center;color:#7e808c;">Status: ${order.status}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }

        async function updateStatus(orderId, newStatus) {
            const token = getToken();
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/update-status/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update status');

                alert(`‚úÖ Order ${newStatus === 'rejected' ? 'rejected' : 'updated'} successfully`);
                await loadOrders();
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.message);
            }
        }

        function showMapModal(address) {
            const modal = document.getElementById('mapModal');
            modal.classList.add('active');
            
            setTimeout(() => initModalMap(address), 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.remove('active');
        }

        function initModalMap(address) {
            if (!window.google) {
                document.getElementById('mapContainer').innerHTML = '<div>Maps API loading...</div>';
                return;
            }

            const defaultLocation = { lat: 28.7041, lng: 77.1025 };
            
            modalMap = new google.maps.Map(document.getElementById('mapContainer'), {
                center: defaultLocation,
                zoom: 13
            });

            modalMarker = new google.maps.Marker({
                position: defaultLocation,
                map: modalMap,
                title: 'Delivery Location'
            });

            // Geocode address
            if (address && address.trim()) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address + ', India' }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        modalMap.setCenter(location);
                        modalMarker.setPosition(location);
                        modalMap.setZoom(15);
                    }
                });
            }
        }

        window.initializeApp = function() {
            loadOrders();
            setInterval(loadOrders, 30000); // Auto-refresh every 30 seconds
        };

        // Load Google Maps API dynamically
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAMeehYlcfmKARKqpP--BVZj7C6GZCUqIQ&callback=initializeApp';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
