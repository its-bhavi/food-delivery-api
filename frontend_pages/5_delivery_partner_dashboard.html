<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Partner Dashboard</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1v0RxpSZc4HvO5GO4dTyGfUqi89oiHI0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-top h1 { font-size: 28px; color: #282c3f; }
        .profile-link { padding: 8px 15px; background: #f0f0f5; border-radius: 8px; text-decoration: none; color: #282c3f; font-weight: 600; font-size: 14px; }
        .gps-status { display: inline-block; padding: 10px 18px; border-radius: 25px; font-size: 14px; font-weight: 600; margin-top: 10px; }
        .gps-status.active { background: #10b981; color: white; animation: pulse 2s infinite; }
        .gps-status.inactive { background: #ef4444; color: white; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .partner-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .info-item { display: flex; flex-direction: column; gap: 5px; }
        .info-label { color: #7e808c; font-size: 13px; font-weight: 600; }
        .info-value { color: #282c3f; font-weight: 600; font-size: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .stat-card h3 { color: #7e808c; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .stat-value { font-size: 36px; font-weight: 700; color: #667eea; }
        .orders-section { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .section-header h2 { font-size: 24px; color: #282c3f; }
        .filter-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-tab { padding: 8px 20px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .filter-tab.active { background: #667eea; color: white; }
        .orders-grid { display: grid; gap: 20px; }
        .order-card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; background: #fafafa; transition: all 0.3s; }
        .order-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .order-number { font-size: 18px; font-weight: 700; color: #282c3f; }
        .order-status { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .order-status.ready { background: #fef3c7; color: #92400e; }
        .order-status.picked { background: #dbeafe; color: #1e40af; }
        .order-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .detail-item { background: white; padding: 12px; border-radius: 8px; }
        .detail-label { color: #7e808c; font-size: 12px; font-weight: 600; margin-bottom: 5px; }
        .detail-value { color: #282c3f; font-size: 15px; font-weight: 600; }
        .order-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-accept { background: #10b981; color: white; }
        .btn-complete { background: #667eea; color: white; }
        .btn-navigate { background: #3b82f6; color: white; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #7e808c; }
        .empty-icon { font-size: 60px; margin-bottom: 15px; opacity: 0.5; }
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        
        /* Map Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 22px; color: #282c3f; }
        .close-modal { font-size: 32px; cursor: pointer; color: #7e808c; }
        .map-container { height: 400px; border-radius: 12px; overflow: hidden; margin-top: 15px; }
        .route-info { background: #f0f0f5; padding: 15px; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>üõµ Delivery Dashboard</h1>
                <a href="/delivery-partner-profile-setup/" class="profile-link">‚öôÔ∏è Profile</a>
            </div>
            <div id="gpsStatus" class="gps-status inactive">üìç GPS: Initializing...</div>
            <div class="partner-info">
                <div class="info-item">
                    <span class="info-label">Partner</span>
                    <span class="info-value" id="partnerName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value" id="partnerPhone">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Vehicle</span>
                    <span class="info-value" id="partnerVehicle">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value" id="partnerStatus">-</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Today's Deliveries</h3>
                <div class="stat-value" id="todayDeliveries">0</div>
            </div>
            <div class="stat-card">
                <h3>Active Orders</h3>
                <div class="stat-value" id="activeOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Earnings</h3>
                <div class="stat-value" id="totalEarnings">‚Çπ0</div>
            </div>
            <div class="stat-card">
                <h3>GPS Updates Sent</h3>
                <div class="stat-value" id="gpsSent">0</div>
            </div>
        </div>

        <div class="orders-section">
            <div class="section-header">
                <h2>üì¶ Available Orders</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterOrders('all')">All</button>
                    <button class="filter-tab" onclick="filterOrders('ready')">Ready</button>
                    <button class="filter-tab" onclick="filterOrders('picked')">In Transit</button>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div id="ordersContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Modal -->
    <div id="navModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üó∫Ô∏è Navigation</h2>
                <span class="close-modal" onclick="closeNavModal()">√ó</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://food-delivery-api-fr4f.onrender.com/api';
        let allOrders = [];
        let currentFilter = 'all';
        let geoWatchId = null;
        let gpsUpdateCount = 0;
        let map, startMarker, endMarker, directionsRenderer;

        function getToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }

        async function loadPartnerInfo() {
            const token = getToken();
            try {
                const response = await fetch(`${API_BASE}/users/profile/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('partnerName').textContent = `${data.first_name} ${data.last_name}`;
                    if (data.delivery_partner) {
                        document.getElementById('partnerPhone').textContent = data.delivery_partner.phone || '-';
                        document.getElementById('partnerVehicle').textContent = `${data.delivery_partner.vehicle_type} - ${data.delivery_partner.vehicle_number}`;
                        document.getElementById('partnerStatus').textContent = data.delivery_partner.status.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
            }
        }

        async function loadOrders() {
            const token = getToken();
            if (!token) {
                alert('Please login first');
                window.location.href = '/login/';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/orders/delivery-orders/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 403) {
                    alert('Access denied. Please ensure you are logged in as a delivery partner.');
                    return;
                }

                if (!response.ok) throw new Error('Failed to load orders');

                const data = await response.json();
                allOrders = Array.isArray(data) ? data : (data.orders || []);
                console.log('üì¶ Orders loaded:', allOrders.length);
                
                updateStats();
                displayOrders();
            } catch (error) {
                console.error('‚ùå Error:', error);
                showAlert('Failed to load orders: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayOrders = allOrders.filter(o => new Date(o.created_at).toDateString() === today);
            const delivered = todayOrders.filter(o => o.status === 'delivered');
            const active = allOrders.filter(o => ['ready', 'picked'].includes(o.status));
            const earnings = delivered.reduce((sum, o) => sum + (parseFloat(o.delivery_charge) || 50), 0);
            
            document.getElementById('todayDeliveries').textContent = delivered.length;
            document.getElementById('activeOrders').textContent = active.length;
            document.getElementById('totalEarnings').textContent = `‚Çπ${earnings.toFixed(2)}`;
            document.getElementById('gpsSent').textContent = gpsUpdateCount;
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            displayOrders();
        }

        function displayOrders() {
            let filtered = currentFilter === 'all' ? allOrders : allOrders.filter(o => o.status === currentFilter);
            
            if (filtered.length === 0) {
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <p>No ${currentFilter} orders available</p>
                    </div>
                `;
                return;
            }

            const html = filtered.map(order => createOrderCard(order)).join('');
            document.getElementById('ordersContainer').innerHTML = `<div class="orders-grid">${html}</div>`;
        }

        function createOrderCard(order) {
            const statusClass = order.status.toLowerCase();
            const restaurantAddr = order.restaurant?.address || 'N/A';
            const customerAddr = order.delivery_address || 'N/A';
            
            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">#${order.order_number}</div>
                        <div class="order-status ${statusClass}">${order.status}</div>
                    </div>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">üè™ Restaurant</div>
                            <div class="detail-value">${order.restaurant?.name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üë§ Customer</div>
                            <div class="detail-value">${order.customer?.first_name || 'Customer'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üí∞ Amount</div>
                            <div class="detail-value">‚Çπ${parseFloat(order.grand_total || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üí≥ Payment</div>
                            <div class="detail-value">${order.payment_method === 'cod' ? 'COD' : 'Paid'}</div>
                        </div>
                    </div>

                    <div class="order-details">
                        <div class="detail-item" style="grid-column: 1/-1;">
                            <div class="detail-label">üìç Delivery Address</div>
                            <div class="detail-value" style="font-size:13px;">${customerAddr}</div>
                        </div>
                    </div>

                    <div class="order-actions">
                        ${getActionButtons(order, restaurantAddr, customerAddr)}
                    </div>
                </div>
            `;
        }

        function getActionButtons(order, restaurantAddr, customerAddr) {
            if (order.status === 'ready') {
                return `
                    <button class="btn btn-accept" onclick="acceptDelivery(${order.id})">üö¥ Accept Delivery</button>
                    <button class="btn btn-navigate" onclick="showNavModal('${escapeHtml(restaurantAddr)}', 'Restaurant')">üó∫Ô∏è Navigate to Restaurant</button>
                `;
            } else if (order.status === 'picked') {
                return `
                    <button class="btn btn-complete" onclick="markDelivered(${order.id})">‚úÖ Mark Delivered</button>
                    <button class="btn btn-navigate" onclick="showNavModal('${escapeHtml(customerAddr)}', 'Customer')">üó∫Ô∏è Navigate to Customer</button>
                `;
            }
            return '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }

        async function acceptDelivery(orderId) {
            if (!confirm('Accept this delivery?')) return;

            const token = getToken();
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/update-status/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'picked' })
                });

                if (!response.ok) throw new Error('Failed to accept');

                showAlert('‚úÖ Delivery accepted! GPS tracking started automatically.', 'success');
                await loadOrders();
            } catch (error) {
                console.error('‚ùå Error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function markDelivered(orderId) {
            if (!confirm('Mark this order as delivered?')) return;

            const token = getToken();
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/update-status/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'delivered' })
                });

                if (!response.ok) throw new Error('Failed to mark delivered');

                showAlert('üéâ Order delivered successfully!', 'success');
                await loadOrders();
            } catch (error) {
                console.error('‚ùå Error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function showNavModal(address, destination) {
            const modal = document.getElementById('navModal');
            modal.classList.add('active');
            
            document.getElementById('modalTitle').textContent = `üó∫Ô∏è Navigate to ${destination}`;
            document.getElementById('modalBody').innerHTML = `
                <p><strong>Destination:</strong> ${address}</p>
                <div id="navMap" class="map-container"></div>
                <div class="route-info">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}&travelmode=driving" 
                       target="_blank" class="btn btn-navigate" style="width:100%;text-align:center;display:block;text-decoration:none;">
                        üöÄ Open in Google Maps
                    </a>
                </div>
            `;

            setTimeout(() => initNavMap(address), 100);
        }

        function initNavMap(address) {
            const defaultLocation = { lat: 28.7041, lng: 77.1025 };
            
            map = new google.maps.Map(document.getElementById('navMap'), {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: false
            });

            endMarker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                title: 'Destination'
            });

            // Geocode the address
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address + ', India' }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    endMarker.setPosition(location);
                    map.setZoom(15);
                }
            });
        }

        function closeNavModal() {
            document.getElementById('navModal').classList.remove('active');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function startLiveGPS() {
            if (!navigator.geolocation) {
                document.getElementById('gpsStatus').textContent = 'üìç GPS: Not Supported';
                return;
            }

            document.getElementById('gpsStatus').textContent = 'üìç GPS: Requesting Permission...';
            
            geoWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    document.getElementById('gpsStatus').className = 'gps-status active';
                    document.getElementById('gpsStatus').textContent = `üìç GPS: Active (¬±${Math.round(pos.coords.accuracy)}m)`;
                    
                    console.log('üìç Current GPS:', pos.coords.latitude, pos.coords.longitude);
                    
                    // Send location for all picked orders
                    const pickedOrders = allOrders.filter(o => o.status === 'picked');
                    pickedOrders.forEach(o => sendLocation(o.id, pos.coords.latitude, pos.coords.longitude));
                },
                (err) => {
                    console.error('‚ùå GPS Error:', err.message);
                    document.getElementById('gpsStatus').className = 'gps-status inactive';
                    document.getElementById('gpsStatus').textContent = 'üìç GPS: Permission Denied';
                },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
            );
        }

        async function sendLocation(orderId, lat, lng) {
            const token = getToken();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/update-location/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                if (response.ok) {
                    gpsUpdateCount++;
                    updateStats();
                    console.log(`‚úÖ GPS sent for order #${orderId}`);
                }
            } catch (error) {
                console.error('‚ùå GPS send failed:', error);
            }
        }

        async function init() {
            await loadPartnerInfo();
            await loadOrders();
            startLiveGPS();
            setInterval(loadOrders, 30000); // Auto-refresh every 30 seconds
        }

        window.addEventListener('beforeunload', () => {
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
        });

        window.addEventListener('load', init);
    </script>
</body>
</html>
