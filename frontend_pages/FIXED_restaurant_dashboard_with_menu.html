<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #fc8019 0%, #e23744 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: 600; color: #fc8019; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; }
        .tab-btn { padding: 12px 24px; border: none; background: transparent; cursor: pointer; font-size: 15px; font-weight: 600; color: #666; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: #fc8019; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .menu-section { background: white; padding: 30px; border-radius: 12px; }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .menu-header h2 { font-size: 22px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #fc8019; color: white; }
        .btn-primary:hover { background: #e67316; transform: translateY(-2px); }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-item-card { background: #f8f8f8; border-radius: 12px; padding: 15px; display: flex; gap: 15px; }
        .menu-item-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #ddd; }
        .menu-item-info { flex: 1; }
        .menu-item-info h3 { font-size: 16px; margin-bottom: 5px; }
        .menu-item-info p { font-size: 13px; color: #666; margin-bottom: 8px; }
        .menu-item-price { font-size: 18px; font-weight: 600; color: #fc8019; }
        .menu-item-actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-edit { background: #17a2b8; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 22px; }
        .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #666; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; font-family: inherit; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #fc8019; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top-color: #fc8019; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Restaurant Dashboard</h1>
            <p id="restaurantName">Welcome back!</p>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üì¶ Total Orders</h3>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>üçï Menu Items</h3>
                <div class="value" id="totalMenuItems">0</div>
            </div>
            <div class="stat-card">
                <h3>‚≠ê Rating</h3>
                <div class="value" id="rating">4.0</div>
            </div>
            <div class="stat-card">
                <h3>üí∞ Revenue</h3>
                <div class="value">‚Çπ0</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('menu')">Menu Items</button>
            <button class="tab-btn" onclick="switchTab('orders')">Orders</button>
            <button class="tab-btn" onclick="switchTab('profile')">Profile</button>
        </div>
        
        <!-- Menu Tab -->
        <div id="menu-tab" class="tab-content active">
            <div class="menu-section">
                <div class="menu-header">
                    <h2>Menu Management</h2>
                    <button class="btn btn-primary" onclick="openAddMenuModal()">+ Add Menu Item</button>
                </div>
                
                <div id="menuItemsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading menu items...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content">
            <div class="menu-section">
                <h2>Recent Orders</h2>
                <p style="margin-top: 20px; color: #666;">Orders section coming soon...</p>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div class="menu-section">
                <h2>Restaurant Profile</h2>
                <p style="margin-top: 20px; color: #666;"><a href="/restaurant-profile/">Edit Profile ‚Üí</a></p>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Menu Item Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Menu Item</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="menuItemForm">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="itemName" required placeholder="e.g., Margherita Pizza">
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="itemDescription" rows="3" placeholder="Delicious description..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Price (‚Çπ) *</label>
                    <input type="number" id="itemPrice" required placeholder="299" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Category *</label>
                    <select id="itemCategory">
                        <option value="appetizer">Appetizer</option>
                        <option value="main_course">Main Course</option>
                        <option value="dessert">Dessert</option>
                        <option value="beverage">Beverage</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="itemVegetarian"> Vegetarian
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="itemAvailable" checked> Available
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Item Image</label>
                    <input type="file" id="itemImage" accept="image/*">
                    <img id="imagePreview" style="max-width: 100%; margin-top: 10px; border-radius: 8px; display: none;">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Save Menu Item
                </button>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://food-delivery-api-production-1d00.up.railway.app/api';
        let currentEditId = null;
        let menuItems = [];
        
        function getToken() {
            return localStorage.getItem('access_token') || 
                   localStorage.getItem('authToken') || 
                   sessionStorage.getItem('authToken');
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Load restaurant profile
        async function loadProfile() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login/';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/vendors/profile/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('restaurantName').textContent = `Welcome, ${data.name}!`;
                    document.getElementById('rating').textContent = data.rating || '4.0';
                } else if (response.status === 404) {
                    showAlert('Please complete your restaurant profile first', 'error');
                    setTimeout(() => window.location.href = '/restaurant-profile/', 2000);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Load menu items
        async function loadMenuItems() {
            const token = getToken();
            document.getElementById('menuItemsList').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading menu items...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/vendors/menu-items/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    menuItems = data.menu_items;
                    document.getElementById('totalMenuItems').textContent = data.count || 0;
                    displayMenuItems(menuItems);
                } else {
                    throw new Error('Failed to load menu items');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('menuItemsList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòï</div>
                        <h3>Failed to load menu items</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function displayMenuItems(items) {
            const container = document.getElementById('menuItemsList');
            
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üçΩÔ∏è</div>
                        <h3>No menu items yet</h3>
                        <p>Add your first menu item to get started!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="menu-grid">';
            items.forEach(item => {
                const imageUrl = item.image || 'https://via.placeholder.com/80';
                html += `
                    <div class="menu-item-card">
                        <img src="${imageUrl}" class="menu-item-image" alt="${item.name}">
                        <div class="menu-item-info">
                            <h3>${item.name} ${item.is_vegetarian ? 'üå±' : ''}</h3>
                            <p>${item.description || 'No description'}</p>
                            <div class="menu-item-price">‚Çπ${item.price}</div>
                            <div class="menu-item-actions">
                                <button class="btn btn-sm btn-edit" onclick="editMenuItem(${item.id})">Edit</button>
                                <button class="btn btn-sm btn-delete" onclick="deleteMenuItem(${item.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function openAddMenuModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add Menu Item';
            document.getElementById('menuItemForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('menuModal').classList.add('show');
        }
        
        function editMenuItem(id) {
            const item = menuItems.find(m => m.id === id);
            if (!item) return;
            
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemVegetarian').checked = item.is_vegetarian;
            document.getElementById('itemAvailable').checked = item.is_available;
            
            if (item.image) {
                document.getElementById('imagePreview').src = item.image;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            document.getElementById('menuModal').classList.add('show');
        }
        
        async function deleteMenuItem(id) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;
            
            const token = getToken();
            try {
                const response = await fetch(`${API_BASE}/vendors/menu-items/${id}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showAlert('Menu item deleted successfully', 'success');
                    loadMenuItems();
                } else {
                    throw new Error('Failed to delete');
                }
            } catch (error) {
                showAlert('Error deleting menu item: ' + error.message, 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('menuModal').classList.remove('show');
        }
        
        // Handle form submit
        document.getElementById('menuItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = getToken();
            const formData = new FormData();
            
            formData.append('name', document.getElementById('itemName').value);
            formData.append('description', document.getElementById('itemDescription').value);
            formData.append('price', document.getElementById('itemPrice').value);
            formData.append('category', document.getElementById('itemCategory').value);
            formData.append('is_vegetarian', document.getElementById('itemVegetarian').checked);
            formData.append('is_available', document.getElementById('itemAvailable').checked);
            
            const imageFile = document.getElementById('itemImage').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            try {
                const url = currentEditId 
                    ? `${API_BASE}/vendors/menu-items/${currentEditId}/`
                    : `${API_BASE}/vendors/menu-items/`;
                    
                const method = currentEditId ? 'PUT' : 'POST';
                
                console.log('üöÄ Submitting to:', url);
                console.log('üìù Method:', method);
                console.log('üîë Token:', token ? 'Present' : 'Missing');
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Success:', data);
                    showAlert(currentEditId ? 'Menu item updated!' : 'Menu item added!', 'success');
                    closeModal();
                    loadMenuItems();
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    let errorMessage = 'Failed to save menu item';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || JSON.stringify(errorData);
                    } catch (e) {
                        errorMessage = `Server error (${response.status}): ${errorText.substring(0, 100)}`;
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('üí• Full error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        });
        
        // Image preview
        document.getElementById('itemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Initialize
        loadProfile();
        loadMenuItems();
    </script>
</body>
</html>
