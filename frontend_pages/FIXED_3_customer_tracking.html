<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Order Tracking</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #fc8019 0%, #e23744 100%); padding: 25px; border-radius: 15px; color: white; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .status-badge { display: inline-block; padding: 8px 20px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 14px; }
        .status-badge.live { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .map-section { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .map-container { height: 500px; border-radius: 12px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666; }
        .map-legend { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-dot.restaurant { background: #10b981; }
        .legend-dot.delivery { background: #f59e0b; }
        .legend-dot.customer { background: #3b82f6; }
        .info-section { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .card h3 { margin-bottom: 15px; color: #282c3f; font-size: 18px; }
        .timeline { position: relative; padding-left: 30px; }
        .timeline-item { position: relative; padding-bottom: 25px; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: -24px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #e0e0e0; border: 3px solid white; box-shadow: 0 0 0 2px #e0e0e0; }
        .timeline-item.active::before { background: #10b981; box-shadow: 0 0 0 2px #10b981; }
        .timeline-item.completed::before { background: #10b981; box-shadow: 0 0 0 2px #10b981; }
        .timeline::after { content: ''; position: absolute; left: -19px; top: 10px; width: 2px; height: calc(100% - 10px); background: #e0e0e0; }
        .timeline-label { font-size: 13px; color: #7e808c; text-transform: uppercase; }
        .timeline-status { font-size: 15px; font-weight: 600; color: #282c3f; margin-top: 3px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .detail-label { color: #7e808c; font-size: 13px; }
        .detail-value { font-weight: 600; color: #282c3f; }
        .btn-call { background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .loading { text-align: center; padding: 40px; color: white; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <p>Loading order details...</p>
    </div>

    <div class="container" id="mainContent" style="display:none;">
        <div class="header">
            <h1>üçï Live Order Tracking</h1>
            <div class="status-badge" id="orderStatus">On the Way</div>
        </div>

        <div class="grid">
            <div class="map-section">
                <h2 style="margin-bottom: 15px; color: #282c3f;">üìç Track Your Delivery</h2>
                <div id="map" class="map-container">
                    <div>Map will load here...</div>
                </div>
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-dot restaurant"></div>
                        <span>Restaurant</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot delivery"></div>
                        <span>Delivery Partner</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot customer"></div>
                        <span>You</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <div class="card">
                    <h3>üì¶ Order Timeline</h3>
                    <div class="timeline" id="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-label">Order Placed</div>
                            <div class="timeline-status">‚úÖ Confirmed</div>
                        </div>
                        <div class="timeline-item active">
                            <div class="timeline-label">On the Way</div>
                            <div class="timeline-status">üö¥ Delivery partner is coming!</div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-label">Delivery</div>
                            <div class="timeline-status">‚è≥ Pending</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üö¥ Delivery Partner</h3>
                    <div id="deliveryInfo">
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value" id="partnerName">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value" id="partnerPhone">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle</span>
                            <span class="detail-value" id="partnerVehicle">-</span>
                        </div>
                        <button class="btn-call" onclick="callPartner()">üìû Call Partner</button>
                    </div>
                </div>

                <div class="card">
                    <h3>üè™ Restaurant</h3>
                    <div class="detail-row">
                        <span class="detail-label">Name</span>
                        <span class="detail-value" id="restaurantName">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Order Total</span>
                        <span class="detail-value" id="orderTotal">‚Çπ0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Payment</span>
                        <span class="detail-value" id="paymentMethod">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://food-delivery-api-fr4f.onrender.com/api';
        let map, restaurantMarker, deliveryMarker, customerMarker;
        let orderId = null;
        let liveUpdateInterval = null;

        function getOrderIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('order');
        }

        function getToken() {
            return localStorage.getItem('access_token') || 
                   localStorage.getItem('authToken') || 
                   sessionStorage.getItem('authToken');
        }

        function initMap() {
            const delhi = { lat: 28.7041, lng: 77.1025 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: delhi,
                zoom: 13,
                mapTypeControl: false
            });

            // Restaurant marker (Green)
            restaurantMarker = new google.maps.Marker({
                map: map,
                title: 'Restaurant',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 2
                }
            });

            // Delivery partner marker (Orange - Animated)
            deliveryMarker = new google.maps.Marker({
                map: map,
                title: 'Delivery Partner',
                animation: google.maps.Animation.BOUNCE,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#f59e0b',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 2
                }
            });

            // Customer marker (Blue)
            customerMarker = new google.maps.Marker({
                map: map,
                title: 'Your Location',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#3b82f6',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 2
                }
            });
        }

        function updateMarkers(trackingData) {
            const bounds = new google.maps.LatLngBounds();

            // Restaurant location
            if (trackingData.restaurant_latitude && trackingData.restaurant_longitude) {
                const restaurantPos = {
                    lat: parseFloat(trackingData.restaurant_latitude),
                    lng: parseFloat(trackingData.restaurant_longitude)
                };
                restaurantMarker.setPosition(restaurantPos);
                bounds.extend(restaurantPos);
            }

            // Delivery partner location
            if (trackingData.delivery_latitude && trackingData.delivery_longitude) {
                const deliveryPos = {
                    lat: parseFloat(trackingData.delivery_latitude),
                    lng: parseFloat(trackingData.delivery_longitude)
                };
                deliveryMarker.setPosition(deliveryPos);
                bounds.extend(deliveryPos);
            }

            // Customer location
            if (trackingData.customer_latitude && trackingData.customer_longitude) {
                const customerPos = {
                    lat: parseFloat(trackingData.customer_latitude),
                    lng: parseFloat(trackingData.customer_longitude)
                };
                customerMarker.setPosition(customerPos);
                bounds.extend(customerPos);
            }

            map.fitBounds(bounds);
        }

        function updateTimeline(status) {
            const statusMap = {
                'pending': 0,
                'confirmed': 0,
                'preparing': 0,
                'ready': 1,
                'picked': 1,
                'delivered': 2
            };

            const activeIndex = statusMap[status] || 0;
            const items = document.querySelectorAll('.timeline-item');
            
            items.forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index < activeIndex) {
                    item.classList.add('completed');
                } else if (index === activeIndex) {
                    item.classList.add('active');
                }
            });

            // Update status badge
            const badge = document.getElementById('orderStatus');
            badge.className = 'status-badge';
            
            if (status === 'picked') {
                badge.textContent = 'üö¥ On the Way';
                badge.classList.add('live');
            } else if (status === 'delivered') {
                badge.textContent = '‚úÖ Delivered';
            } else {
                badge.textContent = '‚è≥ ' + status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        async function loadOrderTracking() {
            const token = getToken();
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/tracking/`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) {
                    throw new Error('Order not found');
                }

                const data = await response.json();
                console.log('üì¶ Tracking data:', data);

                // Update UI
                document.getElementById('restaurantName').textContent = data.restaurant_name || 'N/A';
                document.getElementById('orderTotal').textContent = `‚Çπ${parseFloat(data.grand_total || 0).toFixed(2)}`;
                document.getElementById('paymentMethod').textContent = data.payment_method === 'cod' ? 'Cash on Delivery' : 'Paid Online';

                // Delivery partner info
                if (data.delivery_partner_name) {
                    document.getElementById('partnerName').textContent = data.delivery_partner_name;
                    document.getElementById('partnerPhone').textContent = data.delivery_partner_phone || '-';
                    document.getElementById('partnerVehicle').textContent = data.delivery_partner_vehicle || '-';
                }

                // Update timeline
                updateTimeline(data.status);

                // Update map markers
                updateMarkers(data);

                // Start live updates if order is picked
                if (data.status === 'picked' && !liveUpdateInterval) {
                    liveUpdateInterval = setInterval(loadOrderTracking, 10000); // Update every 10 seconds
                }

                // Stop updates if delivered
                if (data.status === 'delivered' && liveUpdateInterval) {
                    clearInterval(liveUpdateInterval);
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Failed to load order tracking: ' + error.message);
            }
        }

        function callPartner() {
            const phone = document.getElementById('partnerPhone').textContent;
            if (phone && phone !== '-') {
                window.location.href = `tel:${phone}`;
            } else {
                alert('Partner phone number not available');
            }
        }

        window.initializeApp = function() {
            orderId = getOrderIdFromURL();
            
            if (!orderId) {
                alert('Order ID not provided in URL');
                return;
            }

            initMap();
            loadOrderTracking();

            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        };

        // Load Google Maps API dynamically
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyD1v0RxpSZc4HvO5GO4dTyGfUqi89oiHI0&callback=initializeApp';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
