<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Order - Live</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1v0RxpSZc4HvO5GO4dTyGfUqi89oiHI0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f8f8; }
        .header { background: linear-gradient(135deg, #fc8019 0%, #e23744 100%); padding: 15px 20px; color: white; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 20px; }
        .back-btn { color: white; text-decoration: none; font-size: 24px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .map-container { height: 400px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        .status-banner { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 20px; }
        .status-icon { font-size: 60px; }
        .status-info h2 { font-size: 24px; color: #282c3f; margin-bottom: 5px; }
        .status-info p { color: #7e808c; }
        .live-badge { display: inline-block; padding: 5px 12px; background: #10b981; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .timeline { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .timeline-item { display: flex; gap: 20px; margin-bottom: 30px; position: relative; }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: 19px; top: 40px; bottom: -30px; width: 2px; background: #e0e0e0; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; background: #f0f0f0; position: relative; z-index: 1; }
        .timeline-dot.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 0 0 4px rgba(16,185,129,0.2); }
        .timeline-dot.completed { background: #10b981; color: white; }
        .timeline-content h3 { font-size: 16px; color: #282c3f; margin-bottom: 5px; }
        .timeline-content p { font-size: 14px; color: #7e808c; }
        .timeline-content .time { font-size: 12px; color: #93959f; margin-top: 5px; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .detail-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .detail-card h3 { font-size: 14px; color: #7e808c; margin-bottom: 15px; text-transform: uppercase; font-weight: 600; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #7e808c; font-size: 14px; }
        .detail-value { color: #282c3f; font-weight: 600; font-size: 14px; }
        .partner-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .partner-card h3 { font-size: 18px; margin-bottom: 15px; opacity: 0.9; }
        .partner-info { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .partner-avatar { width: 60px; height: 60px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; }
        .partner-details h4 { font-size: 20px; margin-bottom: 5px; }
        .partner-details p { opacity: 0.9; font-size: 14px; }
        .btn-call { display: inline-block; padding: 12px 25px; background: white; color: #667eea; text-decoration: none; border-radius: 10px; font-weight: 600; margin-top: 10px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top-color: #fc8019; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box { background: white; border-radius: 15px; padding: 40px; text-align: center; }
        .update-time { text-align: center; padding: 15px; color: #7e808c; font-size: 13px; }
        .map-markers { position: absolute; top: 15px; left: 15px; background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 12px; }
        .marker-legend { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .marker-legend:last-child { margin-bottom: 0; }
        .marker-dot { width: 12px; height: 12px; border-radius: 50%; }
        .marker-restaurant { background: #10b981; }
        .marker-delivery { background: #fc8019; }
        .marker-customer { background: #667eea; }
    </style>
</head>
<body>
    <div class="header">
        <a href="/my-orders/" class="back-btn">‚Üê</a>
        <h1>üî¥ Live Order Tracking</h1>
        <div></div>
    </div>

    <div id="trackingPage" class="container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading tracking information...</p>
        </div>
    </div>

    <script>
        const API_BASE = 'https://food-delivery-api-fr4f.onrender.com/api';
        let map, restaurantMarker, deliveryMarker, customerMarker;
        let trackingData = null;
        let updateInterval = null;

        function getOrderId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('order') || params.get('id') || params.get('order_id');
        }

        function getToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }

        function initMap(restaurantLat, restaurantLng, customerLat, customerLng, deliveryLat, deliveryLng) {
            const mapDiv = document.getElementById('trackingMap');
            if (!mapDiv) return;

            map = new google.maps.Map(mapDiv, {
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false
            });

            // Restaurant marker
            restaurantMarker = new google.maps.Marker({
                position: { lat: restaurantLat, lng: restaurantLng },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                title: 'Restaurant'
            });

            // Customer marker
            customerMarker = new google.maps.Marker({
                position: { lat: customerLat, lng: customerLng },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#667eea',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                title: 'Your Location'
            });

            // Delivery partner marker (if available)
            if (deliveryLat && deliveryLng) {
                deliveryMarker = new google.maps.Marker({
                    position: { lat: deliveryLat, lng: deliveryLng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#fc8019',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    },
                    title: 'Delivery Partner',
                    animation: google.maps.Animation.BOUNCE
                });

                setTimeout(() => deliveryMarker.setAnimation(null), 2000);
            }

            // Fit bounds to show all markers
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(restaurantMarker.getPosition());
            bounds.extend(customerMarker.getPosition());
            if (deliveryMarker) bounds.extend(deliveryMarker.getPosition());
            map.fitBounds(bounds);
        }

        function updateDeliveryMarker(lat, lng) {
            if (!deliveryMarker) {
                deliveryMarker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#fc8019',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    },
                    title: 'Delivery Partner'
                });
            } else {
                deliveryMarker.setPosition({ lat, lng });
                deliveryMarker.setAnimation(google.maps.Animation.DROP);
                setTimeout(() => deliveryMarker.setAnimation(null), 500);
            }
        }

        async function loadTracking() {
            const orderId = getOrderId();
            if (!orderId) {
                showError('Invalid Order', 'No order ID found in URL');
                return;
            }

            const token = getToken();
            if (!token) {
                showError('Login Required', 'Please login to track your order');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/tracking/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error('Session expired. Please login again.');
                    if (response.status === 404) throw new Error('Order not found');
                    throw new Error('Failed to load tracking');
                }

                trackingData = await response.json();
                console.log('üìç Tracking data:', trackingData);
                displayTracking(trackingData);

                // Start live updates if order is being delivered
                if (trackingData.order.status === 'picked') {
                    startLiveUpdates(orderId, token);
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                showError('Unable to Load', error.message);
            }
        }

        function displayTracking(data) {
            const order = data.order;
            const loc = data.location;
            const status = getStatusInfo(order.status);
            const isLive = order.status === 'picked';

            let deliveryPartnerHTML = '';
            if (order.delivery_partner) {
                const dp = order.delivery_partner;
                deliveryPartnerHTML = `
                    <div class="partner-card">
                        <h3>üõµ Your Delivery Partner</h3>
                        <div class="partner-info">
                            <div class="partner-avatar">${dp.first_name.charAt(0)}</div>
                            <div class="partner-details">
                                <h4>${dp.first_name} ${dp.last_name || ''}</h4>
                                <p>${dp.vehicle_type || 'Bike'} - ${dp.vehicle_number || ''}</p>
                            </div>
                        </div>
                        ${dp.phone ? `<a href="tel:${dp.phone}" class="btn-call">üìû Call ${dp.first_name}</a>` : ''}
                    </div>
                `;
            }

            document.getElementById('trackingPage').innerHTML = `
                <div class="status-banner">
                    <div class="status-icon">${status.emoji}</div>
                    <div class="status-info">
                        <h2>${status.text}${isLive ? '<span class="live-badge">LIVE</span>' : ''}</h2>
                        <p>${status.desc}</p>
                    </div>
                </div>

                <div class="map-container">
                    <div id="trackingMap" style="width:100%;height:100%;"></div>
                    <div class="map-markers">
                        <div class="marker-legend"><div class="marker-dot marker-restaurant"></div><span>Restaurant</span></div>
                        <div class="marker-legend"><div class="marker-dot marker-delivery"></div><span>Delivery Partner</span></div>
                        <div class="marker-legend"><div class="marker-dot marker-customer"></div><span>You</span></div>
                    </div>
                </div>

                <div class="timeline">
                    <h3 style="margin-bottom:25px;font-size:18px;color:#282c3f;">üìã Order Timeline</h3>
                    ${getTimelineHTML(order.status)}
                </div>

                <div class="details-grid">
                    <div class="detail-card">
                        <h3>üçΩÔ∏è Restaurant</h3>
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value">${order.restaurant?.name || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">${order.restaurant?.address || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-card">
                        <h3>üìç Delivery Address</h3>
                        <div class="detail-row">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">${order.delivery_address || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Order #</span>
                            <span class="detail-value">${order.order_number}</span>
                        </div>
                    </div>

                    ${deliveryPartnerHTML}

                    <div class="detail-card">
                        <h3>üí∞ Payment</h3>
                        <div class="detail-row">
                            <span class="detail-label">Total Amount</span>
                            <span class="detail-value">‚Çπ${parseFloat(order.grand_total || 0).toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Method</span>
                            <span class="detail-value">${order.payment_method === 'cod' ? 'Cash on Delivery' : 'Paid Online'}</span>
                        </div>
                    </div>
                </div>

                <div class="update-time">
                    ${isLive ? 'üî¥ Live tracking active | ' : ''}Last updated: ${new Date().toLocaleTimeString('en-IN')}
                </div>
            `;

            // Initialize map
            setTimeout(() => {
                initMap(
                    parseFloat(loc.restaurant_lat),
                    parseFloat(loc.restaurant_lng),
                    parseFloat(loc.customer_lat),
                    parseFloat(loc.customer_lng),
                    loc.delivery_lat ? parseFloat(loc.delivery_lat) : null,
                    loc.delivery_lng ? parseFloat(loc.delivery_lng) : null
                );
            }, 100);
        }

        function getTimelineHTML(currentStatus) {
            const statuses = [
                { key: 'pending', icon: '‚è≥', title: 'Order Placed', desc: 'Your order has been received' },
                { key: 'confirmed', icon: '‚úÖ', title: 'Order Confirmed', desc: 'Restaurant confirmed your order' },
                { key: 'preparing', icon: 'üë®‚Äçüç≥', title: 'Preparing Food', desc: 'Your food is being prepared' },
                { key: 'ready', icon: 'üì¶', title: 'Food Ready', desc: 'Waiting for delivery partner' },
                { key: 'picked', icon: 'üõµ', title: 'Out for Delivery', desc: 'On the way to you' },
                { key: 'delivered', icon: 'üéâ', title: 'Delivered', desc: 'Order delivered successfully' }
            ];

            const currentIndex = statuses.findIndex(s => s.key === currentStatus);
            
            return statuses.map((s, index) => {
                const isActive = index === currentIndex;
                const isCompleted = index < currentIndex;
                const dotClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${dotClass}">${s.icon}</div>
                        <div class="timeline-content">
                            <h3>${s.title}</h3>
                            <p>${s.desc}</p>
                            ${isActive || isCompleted ? `<p class="time">${new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startLiveUpdates(orderId, token) {
            console.log('üî¥ Starting live updates...');
            updateInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/orders/${orderId}/tracking/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('üîÑ Live update:', data.location);
                        
                        // Update delivery marker position
                        if (data.location.delivery_lat && data.location.delivery_lng) {
                            updateDeliveryMarker(
                                parseFloat(data.location.delivery_lat),
                                parseFloat(data.location.delivery_lng)
                            );
                        }

                        // If status changed, reload full page
                        if (data.order.status !== trackingData.order.status) {
                            console.log('‚úÖ Status changed, reloading...');
                            trackingData = data;
                            displayTracking(data);
                            
                            if (data.order.status === 'delivered') {
                                clearInterval(updateInterval);
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Live update error:', error);
                }
            }, 10000); // Update every 10 seconds
        }

        function getStatusInfo(status) {
            const map = {
                'pending': { color: '#f39c12', text: 'Order Placed', emoji: '‚è≥', desc: 'Waiting for confirmation' },
                'confirmed': { color: '#3498db', text: 'Confirmed', emoji: '‚úÖ', desc: 'Restaurant confirmed' },
                'preparing': { color: '#9b59b6', text: 'Preparing', emoji: 'üë®‚Äçüç≥', desc: 'Your food is being prepared' },
                'ready': { color: '#27ae60', text: 'Ready', emoji: 'üì¶', desc: 'Ready for pickup' },
                'picked': { color: '#e67e22', text: 'On the Way', emoji: 'üõµ', desc: 'Delivery partner is coming!' },
                'delivered': { color: '#2ecc71', text: 'Delivered', emoji: 'üéâ', desc: 'Enjoy your meal!' },
                'cancelled': { color: '#e74c3c', text: 'Cancelled', emoji: '‚ùå', desc: 'Order cancelled' }
            };
            return map[status] || map['pending'];
        }

        function showError(title, message) {
            document.getElementById('trackingPage').innerHTML = `
                <div class="error-box">
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <button onclick="loadTracking()" class="btn-call" style="margin-top:20px;">üîÑ Retry</button>
                </div>
            `;
        }

        // Cleanup on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // Initialize
        window.addEventListener('load', loadTracking);
    </script>
</body>
</html>
